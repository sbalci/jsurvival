---
name: stagemigration
title: Advanced TNM Stage Migration Analysis
menuGroup: Survival
menuSubgroup: ClinicoPath Survival
menuSubtitle: 'State-of-the-Art Staging System Validation'
version: '0.0.3'
jas: '1.2'

description:
    main: >-
      Comprehensive analysis for validating TNM staging system improvements using state-of-the-art 
      statistical methods. This analysis provides pathologists with robust tools to evaluate whether 
      a new staging system provides superior prognostic discrimination compared to existing systems.
      
      Includes advanced metrics: Net Reclassification Improvement (NRI), Integrated Discrimination 
      Improvement (IDI), time-dependent ROC analysis, decision curve analysis, bootstrap validation, 
      and comprehensive clinical interpretation guidance.
    R:
        dontrun: true
        usage: |
            # Example analyzing TNM staging system migration:
            # stagemigration(
            #   data = cancer_cohort,
            #   oldStage = "tnm7_stage", 
            #   newStage = "tnm8_stage",
            #   survivalTime = "os_months",
            #   event = "death_status",
            #   eventLevel = "Dead",
            #   analysisType = "comprehensive",
            #   calculateNRI = TRUE,
            #   calculateIDI = TRUE,
            #   performBootstrap = TRUE,
            #   bootstrapReps = 1000
            # )

options:
    - name: data
      type: Data
      description:
          R: >
            The dataset containing staging and survival information for TNM validation analysis.

    # Core Variables
    - name: oldStage
      title: 'Original Staging System'
      type: Variable
      suggested: [ordinal, nominal]
      permitted: [factor]
      description: >-
        The original staging variable (e.g., TNM 7th edition, AJCC 7th edition).
        Should be coded as ordered factor with appropriate stage levels.

    - name: newStage
      title: 'New Staging System'
      type: Variable
      suggested: [ordinal, nominal]
      permitted: [factor]
      description: >-
        The proposed new staging variable (e.g., TNM 8th edition, revised staging).
        Should use the same coding structure as the original staging system.

    - name: survivalTime
      title: 'Survival Time'
      type: Variable
      suggested: [continuous]
      permitted: [numeric]
      description: >-
        Time to event or censoring in consistent units (months recommended).
        For overall survival analysis, use time from diagnosis to death or last follow-up.

    - name: event
      title: 'Event Indicator'
      type: Variable
      suggested: [ordinal, nominal, continuous]
      permitted: [factor, numeric]
      description: >-
        Event indicator (1 = event occurred, 0 = censored) or factor with event levels.
        For overall survival, event = death from any cause.

    - name: eventLevel
      title: Event Level
      type: Level
      variable: (event)
      description: >-
        The level indicating event occurrence when using factor variables.

    # Analysis Type and Core Options
    - name: analysisType
      title: 'Analysis Scope'
      type: List
      options:
        - title: "Basic Migration Analysis"
          name: basic
        - title: "Standard Validation (includes C-index, NRI)"
          name: standard  
        - title: "Comprehensive Analysis (all methods)"
          name: comprehensive
        - title: "Publication Ready (optimized for manuscripts)"
          name: publication
      default: comprehensive
      description: >-
        Determines the scope of statistical analysis performed. Comprehensive analysis
        includes all available methods for thorough staging system validation.

    - name: confidenceLevel
      title: 'Confidence Level'
      type: Number
      min: 0.80
      max: 0.99
      default: 0.95
      description: >-
        Confidence level for all confidence intervals and hypothesis tests.

    # Advanced Statistical Methods
    - name: calculateNRI
      title: 'Net Reclassification Improvement (NRI)'
      type: Bool
      default: true
      description: >-
        Calculate Net Reclassification Improvement to quantify improvement in 
        risk classification between staging systems. Essential for staging validation.

    - name: nriTimePoints
      title: 'NRI Time Points (months)'
      type: String
      default: "12, 24, 60"
      description: >-
        Comma-separated time points for NRI calculation (e.g., "12, 24, 60" for 
        1, 2, and 5-year survival). Use clinically relevant time points.

    - name: calculateIDI
      title: 'Integrated Discrimination Improvement (IDI)'
      type: Bool
      default: true
      description: >-
        Calculate Integrated Discrimination Improvement to measure improvement 
        in risk prediction accuracy between staging systems.

    - name: performROCAnalysis
      title: 'Time-dependent ROC Analysis'
      type: Bool
      default: true
      description: >-
        Perform time-dependent ROC analysis to compare discriminative ability
        of staging systems over time.

    - name: rocTimePoints
      title: 'ROC Time Points (months)'
      type: String
      default: "12, 24, 36, 60"
      description: >-
        Time points for ROC analysis. Should include clinically important
        survival milestones for the specific cancer type.

    - name: performDCA
      title: 'Decision Curve Analysis'
      type: Bool
      default: true
      description: >-
        Perform Decision Curve Analysis to assess clinical utility and net benefit
        of the new staging system for clinical decision making.

    - name: performCalibration
      title: 'Calibration Analysis'
      type: Bool
      default: true
      description: >-
        Assess calibration of risk predictions from both staging systems.
        Important for validating accuracy of survival predictions.

    # Validation and Bootstrap Options
    - name: performBootstrap
      title: 'Bootstrap Validation'
      type: Bool
      default: true
      description: >-
        Perform bootstrap validation with optimism correction to assess
        internal validity of results. Recommended for all staging validation studies.

    - name: bootstrapReps
      title: 'Bootstrap Repetitions'
      type: Number
      min: 100
      max: 2000
      default: 1000
      description: >-
        Number of bootstrap repetitions for internal validation. 
        1000 repetitions recommended for stable results.

    - name: performCrossValidation
      title: 'Cross-Validation'
      type: Bool
      default: false
      description: >-
        Perform k-fold cross-validation for additional validation.
        Computationally intensive but provides robust validation.

    - name: cvFolds
      title: 'CV Folds'
      type: Number
      min: 3
      max: 10
      default: 5
      description: >-
        Number of folds for cross-validation when enabled.

    # Clinical Significance Options
    - name: clinicalSignificanceThreshold
      title: 'Clinical Significance Threshold'
      type: Number
      min: 0.01
      max: 0.10
      default: 0.02
      description: >-
        Minimum improvement in C-index considered clinically significant.
        Default 0.02 based on oncology literature recommendations.

    - name: nriClinicalThreshold
      title: 'NRI Clinical Threshold'
      type: Number
      min: 0.10
      max: 0.50
      default: 0.20
      description: >-
        Minimum NRI improvement considered clinically meaningful.
        Default 0.20 (20% net reclassification improvement).

    # Homogeneity and Trend Tests
    - name: performHomogeneityTests
      title: 'Stage Homogeneity Tests'
      type: Bool
      default: true
      description: >-
        Test homogeneity within stages and monotonic trend across stages.
        Essential for validating stage ordering and grouping.

    - name: performTrendTests
      title: 'Stage Trend Analysis'
      type: Bool
      default: true
      description: >-
        Test for monotonic trend in survival across stage levels.
        Validates that higher stages consistently have worse prognosis.

    # Advanced Model Comparison
    - name: performLikelihoodTests
      title: 'Likelihood Ratio Tests'
      type: Bool
      default: true
      description: >-
        Perform formal likelihood ratio tests comparing nested staging models.
        Provides statistical significance testing for staging improvement.

    - name: calculatePseudoR2
      title: 'Pseudo R-squared Measures'
      type: Bool
      default: true
      description: >-
        Calculate multiple pseudo R-squared measures for model comparison
        (Nagelkerke, McFadden, Cox-Snell).

    # Visualization Options
    - name: showMigrationHeatmap
      title: 'Migration Heatmap'
      type: Bool
      default: true
      description: >-
        Display detailed heatmap showing migration patterns between staging systems.

    - name: showROCComparison
      title: 'ROC Curve Comparison'
      type: Bool
      default: true
      description: >-
        Display time-dependent ROC curves comparing staging systems.

    - name: showCalibrationPlots
      title: 'Calibration Plots'
      type: Bool
      default: true
      description: >-
        Display calibration plots for both staging systems.

    - name: showDecisionCurves
      title: 'Decision Curves'
      type: Bool
      default: true
      description: >-
        Display decision curves showing net benefit of staging systems.

    - name: showForestPlot
      title: 'Hazard Ratio Forest Plot'
      type: Bool
      default: true
      description: >-
        Display forest plot with stage-specific hazard ratios and confidence intervals.

    - name: showWillRogersAnalysis
      title: 'Will Rogers Phenomenon Analysis'
      type: Bool
      default: true
      description: >-
        Detailed analysis of Will Rogers phenomenon with survival comparisons
        between migrated and non-migrated patients within stages.

    # Survival Plot Options
    - name: survivalPlotType
      title: 'Survival Plot Display'
      type: List
      options:
        - title: "Separate plots for each system"
          name: separate
        - title: "Side-by-side comparison"
          name: sidebyside
        - title: "Overlay comparison"
          name: overlay
        - title: "Key stages only"
          name: keystages
      default: separate
      description: >-
        Controls display of survival curves for staging system comparison.

    - name: showConfidenceIntervals
      title: 'Show Confidence Intervals'
      type: Bool
      default: true
      description: >-
        Display confidence intervals around survival curves and other estimates.

    - name: showRiskTables
      title: 'Show Risk Tables'
      type: Bool
      default: true
      description: >-
        Display at-risk tables below survival curves.

    - name: plotTimeRange
      title: 'Plot Time Range (months)'
      type: String
      default: "auto"
      description: >-
        Maximum time for survival plots. Use "auto" for automatic range or
        specify maximum months (e.g., "60" for 5-year follow-up).

    # Output and Reporting Options
    - name: showClinicalInterpretation
      title: 'Clinical Interpretation Guide'
      type: Bool
      default: true
      description: >-
        Display comprehensive clinical interpretation of all statistical results
        with guidance for staging system adoption decisions.

    - name: showStatisticalSummary
      title: 'Statistical Summary Table'
      type: Bool
      default: true
      description: >-
        Display comprehensive table summarizing all statistical comparisons.

    - name: showMethodologyNotes
      title: 'Methodology Notes'
      type: Bool
      default: true
      description: >-
        Display detailed notes on statistical methods used and their interpretation.

    - name: includeEffectSizes
      title: 'Include Effect Sizes'
      type: Bool
      default: true
      description: >-
        Calculate and display effect sizes for all comparisons to assess
        practical significance beyond statistical significance.

    - name: generateExecutiveSummary
      title: 'Executive Summary'
      type: Bool
      default: true
      description: >-
        Generate executive summary with key findings and recommendations
        for clinical and research stakeholders.

    # Advanced Options for Specific Cancer Types
    - name: cancerType
      title: 'Cancer Type (Optional)'
      type: List
      options:
        - title: "General (use default thresholds)"
          name: general
        - title: "Lung Cancer"
          name: lung
        - title: "Breast Cancer" 
          name: breast
        - title: "Colorectal Cancer"
          name: colorectal
        - title: "Prostate Cancer"
          name: prostate
        - title: "Head and Neck Cancer"
          name: headneck
        - title: "Melanoma"
          name: melanoma
        - title: "Other Solid Tumor"
          name: other
      default: general
      description: >-
        Optional cancer type specification for customized thresholds and 
        interpretation guidelines based on cancer-specific literature.

    - name: useOptimismCorrection
      title: 'Apply Optimism Correction'
      type: Bool
      default: true
      description: >-
        Apply optimism correction to performance metrics using bootstrap
        validation to avoid overly optimistic estimates.

...